<!-- DataTables + PapaParse + jQuery from CDN -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>

<style>
  /* Basic styling for nested checkboxes */
  .category-block {
    border: 1px solid #ccc;
    padding: 8px;
    margin-bottom: 8px;
  }
  .sub-block {
    border-left: 2px dashed #ccc;
    margin-left: 1em;
    padding-left: 1em;
    margin-top: 4px;
  }
  /* DataTables width */
  table {
    width: 100%;
  }
  .details {
    margin-top: 1em;
  }
  /* Optional: a simple hidden class for toggling display. */
  .hidden {
    display: none;
  }
</style>

<h2>HypoBench Leaderboard</h2>

<!-- Button to collapse/expand the entire task selector -->
<button id="toggleTaskSelectorBtn" style="margin-bottom: 1em;">Hide Task Selection</button>

<p>Select tasks below to filter the aggregated results in real time:</p>

<!-- Container for nested checkboxes -->
<div id="task-selector" style="margin-bottom: 1em;"></div>

<!-- The leaderboard table -->
<table id="leaderboard" class="display"></table>

<script>
/**************************************************
 * 1) Define your multi-level categories object.
 *    EXACTLY match the Task values in your CSVs.
 **************************************************/

/*
   1) Changing top-level category display names:
   We'll map the original keys (admission, admission_adv, etc.)
   to new display strings (College Admission, etc.).
*/
const renameCategory = {
  "admission": "College Admission",
  "admission_adv": "Counterintuitive Admission",
  "election": "Presidential Election",
  "preference": "Personality Prediction",
  "shoe": "Shoe Sales"
};
/**************************************************
 * 1) Define your multi-level categories object.
 *    EXACTLY match the Task values in your CSVs.
 *    Now tasks use underscores, not slashes.
 **************************************************/
const categories = {
  All: null,  // Means no filtering in theory, but we skip in UI
  admission: {
    "level 1": [
      "admission_level_1_base"
    ],
    "level 2": [
      "admission_level_2_depth_2",
      "admission_level_2_distractor_3",
      "admission_level_2_noise_10",
      "admission_level_2_size_5"
    ],
    "level 3": [
      "admission_level_3_depth_3",
      "admission_level_3_distractor_6",
      "admission_level_3_noise_20",
      "admission_level_3_size_10"
    ],
    "level 4": [
      "admission_level_4_depth_4",
      "admission_level_4_distractor_10",
      "admission_level_4_noise_30",
      "admission_level_4_size_15"
    ]
  },
  admission_adv: {
    "level 1": [
      "admission_adv_level_1_base"
    ],
    "level 2": [
      "admission_adv_level_2_depth_2",
      "admission_adv_level_2_distractor_3",
      "admission_adv_level_2_noise_10",
      "admission_adv_level_2_size_5"
    ],
    "level 3": [
      "admission_adv_level_3_depth_3",
      "admission_adv_level_3_distractor_6",
      "admission_adv_level_3_noise_20",
      "admission_adv_level_3_size_10"
    ],
    "level 4": [
      "admission_adv_level_4_depth_4",
      "admission_adv_level_4_distractor_10",
      "admission_adv_level_4_noise_30",
      "admission_adv_level_4_size_15"
    ]
  },
  election: {
    "level 0": [
      "election_level0",
      "election_level0_nosubtlety"
    ],
    "level 1": [
      "election_level1",
      "election_level1_nosubtlety"
    ],
    "level 2": [
      "election_level2",
      "election_level2_nosubtlety"
    ],
    "level 3": [
      "election_level3",
      "election_level3_nosubtlety"
    ],
    "level 4": [
      "election_level4",
      "election_level4_nosubtlety"
    ],
    "level 5": [
      "election_level5",
      "election_level5_nosubtlety"
    ],
    "controlled": [
      "election_controlled_5_0_0",
      "election_controlled_10_0_0",
      "election_controlled_15_0_0",
      "election_controlled_20_0_0",
      "election_controlled_20_0.1_0",
      "election_controlled_20_0.2_0",
      "election_controlled_20_0.3_0",
      "election_controlled_20_0_0.1",
      "election_controlled_20_0_0.2",
      "election_controlled_20_0_0.3",
      "election_controlled_20_0.1_0.1",
      "election_controlled_20_0.2_0.2",
      "election_controlled_20_0.3_0.3"
    ],
    "counterfactual": [
      "election_counterfactual_normal",
      "election_counterfactual_counterfactual"
    ]
  },
  preference: {
    "level 0": [
      "preference_level0",
      "preference_level0_nosubtlety"
    ],
    "level 1": [
      "preference_level1",
      "preference_level1_nosubtlety"
    ],
    "level 2": [
      "preference_level2",
      "preference_level2_nosubtlety"
    ],
    "level 3": [
      "preference_level3",
      "preference_level3_nosubtlety"
    ],
    "level 4": [
      "preference_level4",
      "preference_level4_nosubtlety"
    ],
    "level 5": [
      "preference_level5",
      "preference_level5_nosubtlety"
    ],
    "controlled": [
      "preference_controlled_5_0_0",
      "preference_controlled_10_0_0",
      "preference_controlled_15_0_0",
      "preference_controlled_20_0_0",
      "preference_controlled_20_0.1_0",
      "preference_controlled_20_0.2_0",
      "preference_controlled_20_0.3_0",
      "preference_controlled_20_0_0.1",
      "preference_controlled_20_0_0.2",
      "preference_controlled_20_0_0.3",
      "preference_controlled_20_0.1_0.1",
      "preference_controlled_20_0.2_0.2",
      "preference_controlled_20_0.3_0.3"
    ]
  },
  shoe: {
    "simple": [
      "shoe"
    ],
    "two_level": [
      "shoe_two_level_simple",
      "shoe_two_level_hard"
    ]
  }
};

/**************************************************
 * 2) CSV file paths.
 *    Adjust for your GitHub Pages structure.
 **************************************************/
const csvFiles = [
  "{{ '/assets/data/GPT_combined_results_synth.csv' | relative_url }}",
  "{{ '/assets/data/Llama_combined_results_synth.csv' | relative_url }}",
  "{{ '/assets/data/Qwen_combined_results_synth.csv' | relative_url }}",
  "{{ '/assets/data/DeepSeek_combined_results_synth.csv' | relative_url }}"
];

let allData = []; // will store rows from all CSVs
let table = null; // DataTables instance

//------------------------------------------------------------
// (OPTIONAL) 3) Pretty names for tasks / methods / models
//------------------------------------------------------------
// If you only want to rename certain tasks or methods, define them here.
// The aggregator will keep the original keys to filter, but show these.

const renameTask = {
  // Admission tasks
  "admission_level_1_base": "College Admission Base (Level 1)",
  "admission_level_2_depth_2": "College Admission Depth 2 (Level 2)",
  "admission_level_2_distractor_3": "College Admission Distractor 3 (Level 2)",
  "admission_level_2_noise_10": "College Admission Noise 10% (Level 2)",
  "admission_level_2_size_5": "College Admission Num. Features: 5 (Level 2)",
  "admission_level_3_depth_3": "College Admission Depth 3 (Level 3)",
  "admission_level_3_distractor_6": "College Admission Distractor 6 (Level 3)",
  "admission_level_3_noise_20": "College Admission Noise 20% (Level 3)",
  "admission_level_3_size_10": "College Admission Num. Features: 10 (Level 3)",
  "admission_level_4_depth_4": "College Admission Depth 4 (Level 4)",
  "admission_level_4_distractor_10": "College Admission Distractor 10 (Level 4)",
  "admission_level_4_noise_30": "College Admission Noise 30% (Level 4)",
  "admission_level_4_size_15": "College Admission Num. Features: 15 (Level 4)",

  // Counterintuitive Admission tasks
  "admission_adv_level_1_base": "Counterintuitive Admission Base (Level 1)",
  "admission_adv_level_2_depth_2": "Counterintuitive Admission Depth 2 (Level 2)",
  "admission_adv_level_2_distractor_3": "Counterintuitive Admission Distractor 3 (Level 2)",
  "admission_adv_level_2_noise_10": "Counterintuitive Admission Noise 10% (Level 2)",
  "admission_adv_level_2_size_5": "Counterintuitive Admission Num. Features: 5 (Level 2)",
  "admission_adv_level_3_depth_3": "Counterintuitive Admission Depth 3 (Level 3)",
  "admission_adv_level_3_distractor_6": "Counterintuitive Admission Distractor 6 (Level 3)",
  "admission_adv_level_3_noise_20": "Counterintuitive Admission Noise 20% (Level 3)",
  "admission_adv_level_3_size_10": "Counterintuitive Admission Num. Features: 10 (Level 3)",
  "admission_adv_level_4_depth_4": "Counterintuitive Admission Depth 4 (Level 4)",
  "admission_adv_level_4_distractor_10": "Counterintuitive Admission Distractor 10 (Level 4)",
  "admission_adv_level_4_noise_30": "Counterintuitive Admission Noise 30% (Level 4)",
  "admission_adv_level_4_size_15": "Counterintuitive Admission Num. Features: 15 (Level 4)",

  // Election tasks
  "election_level0": "Presidential Election Level 0",
  "election_level0_nosubtlety": "Presidential Election Level 0 (No Subtlety)",
  "election_level1": "Presidential Election Level 1",
  "election_level1_nosubtlety": "Presidential Election Level 1 (No Subtlety)",
  "election_level2": "Presidential Election Level 2",
  "election_level2_nosubtlety": "Presidential Election Level 2 (No Subtlety)",
  "election_level3": "Presidential Election Level 3",
  "election_level3_nosubtlety": "Presidential Election Level 3 (No Subtlety)",
  "election_level4": "Presidential Election Level 4",
  "election_level4_nosubtlety": "Presidential Election Level 4 (No Subtlety)",
  "election_level5": "Presidential Election Level 5",
  "election_level5_nosubtlety": "Presidential Election Level 5 (No Subtlety)",
  "election_controlled_5_0_0": "Presidential Election Controlled (Num. Features: 5, Noise: 0%, Dropout: 0%)",
  "election_controlled_10_0_0": "Presidential Election Controlled (Num. Features: 10, Noise: 0%, Dropout: 0%)",
  "election_controlled_15_0_0": "Presidential Election Controlled (Num. Features: 15, Noise: 0%, Dropout: 0%)",
  "election_controlled_20_0_0": "Presidential Election Controlled (Num. Features: 20, Noise: 0%, Dropout: 0%)",
  "election_controlled_20_0.1_0": "Presidential Election Controlled (Num. Features: 20, Noise: 10%, Dropout: 0%)",
  "election_controlled_20_0.2_0": "Presidential Election Controlled (Num. Features: 20, Noise: 20%, Dropout: 0%)",
  "election_controlled_20_0.3_0": "Presidential Election Controlled (Num. Features: 20, Noise: 30%, Dropout: 0%)",
  "election_controlled_20_0_0.1": "Presidential Election Controlled (Num. Features: 20, Noise: 0%, Dropout: 10%)",
  "election_controlled_20_0_0.2": "Presidential Election Controlled (Num. Features: 20, Noise: 0%, Dropout: 20%)",
  "election_controlled_20_0_0.3": "Presidential Election Controlled (Num. Features: 20, Noise: 0%, Dropout: 30%)",
  "election_controlled_20_0.1_0.1": "Presidential Election Controlled (Num. Features: 20, Noise: 10%, Dropout: 10%)",
  "election_controlled_20_0.2_0.2": "Presidential Election Controlled (Num. Features: 20, Noise: 20%, Dropout: 20%)",
  "election_controlled_20_0.3_0.3": "Presidential Election Controlled (Num. Features: 20, Noise: 30%, Dropout: 30%)",
  "election_counterfactual_normal": "Presidential Election Counterfactual (Normal)",
  "election_counterfactual_counterfactual": "Presidential Election Counterfactual",

  // Preference tasks
  "preference_level0": "Personality Prediction Level 0",
  "preference_level0_nosubtlety": "Personality Prediction Level 0 (No Subtlety)",
  "preference_level1": "Personality Prediction Level 1",
  "preference_level1_nosubtlety": "Personality Prediction Level 1 (No Subtlety)",
  "preference_level2": "Personality Prediction Level 2",
  "preference_level2_nosubtlety": "Personality Prediction Level 2 (No Subtlety)",
  "preference_level3": "Personality Prediction Level 3",
  "preference_level3_nosubtlety": "Personality Prediction Level 3 (No Subtlety)",
  "preference_level4": "Personality Prediction Level 4",
  "preference_level4_nosubtlety": "Personality Prediction Level 4 (No Subtlety)",
  "preference_level5": "Personality Prediction Level 5",
  "preference_level5_nosubtlety": "Personality Prediction Level 5 (No Subtlety)",
  "preference_controlled_5_0_0": "Personality Prediction Controlled (Num. Features: 5, Noise: 0%, Dropout: 0%)",
  "preference_controlled_10_0_0": "Personality Prediction Controlled (Num. Features: 10, Noise: 0%, Dropout: 0%)",
  "preference_controlled_15_0_0": "Personality Prediction Controlled (Num. Features: 15, Noise: 0%, Dropout: 0%)",
  "preference_controlled_20_0_0": "Personality Prediction Controlled (Num. Features: 20, Noise: 0%, Dropout: 0%)",
  "preference_controlled_20_0.1_0": "Personality Prediction Controlled (Num. Features: 20, Noise: 10%, Dropout: 0%)",
  "preference_controlled_20_0.2_0": "Personality Prediction Controlled (Num. Features: 20, Noise: 20%, Dropout: 0%)",
  "preference_controlled_20_0.3_0": "Personality Prediction Controlled (Num. Features: 20, Noise: 30%, Dropout: 0%)",
  "preference_controlled_20_0_0.1": "Personality Prediction Controlled (Num. Features: 20, Noise: 0%, Dropout: 10%)",
  "preference_controlled_20_0_0.2": "Personality Prediction Controlled (Num. Features: 20, Noise: 0%, Dropout: 20%)",
  "preference_controlled_20_0_0.3": "Personality Prediction Controlled (Num. Features: 20, Noise: 0%, Dropout: 30%)",
  "preference_controlled_20_0.1_0.1": "Personality Prediction Controlled (Num. Features: 20, Noise: 10%, Dropout: 10%)",
  "preference_controlled_20_0.2_0.2": "Personality Prediction Controlled (Num. Features: 20, Noise: 20%, Dropout: 20%)",
  "preference_controlled_20_0.3_0.3": "Personality Prediction Controlled (Num. Features: 20, Noise: 30%, Dropout: 30%)",

  // Shoe tasks
  "shoe": "Shoe Sales Base",
  "shoe_two_level_simple": "Shoe Sales Two-Level Simple",
  "shoe_two_level_hard": "Shoe Sales Two-Level Hard"
};

const renameMethod = {
  "Zero-shot Inference": "Zero-shot Inference",
  "Few-shot Inference": "Few-shot Inference",
  "Zero-shot Generation": "Zero-shot Generation",
  "\\ioprompt": "IO Prompting",
  "\\iorefine": "Iterative Refinement",
  "\\hypogenic": "HypoGeniC"
};

const renameModel = {
  "GPT": "GPT-4o-mini",
  "Llama": "Llama-3.1-70B-Instruct",
  "Qwen": "Qwen-2.5-72B-Instruct",
  "DeepSeek": "DeepSeek-R1-Distill-Llama-70B-local"
};


//------------------------------------------------------------
// BUILD THE NESTED CHECKBOX UI
//------------------------------------------------------------
function buildNestedUI() {
  const container = document.getElementById('task-selector');
  container.innerHTML = '';

  // Iterate top-level categories
  for (const topCat in categories) {
    if (topCat === 'All') continue; // skip if you want

    const subLevels = categories[topCat];

    // 1) Container for each top-level category
    const topDiv = document.createElement('div');
    topDiv.className = 'category-block';

    // get new display name from renameCategory
    const displayCatName = renameCategory[topCat] || topCat;

    // 2) Top-level checkbox
    const topLabel = document.createElement('label');
    const topCheckbox = document.createElement('input');
    topCheckbox.type = 'checkbox';
    topCheckbox.value = topCat;
    // Default: check top-level to select all tasks
    topCheckbox.checked = true;

    topLabel.appendChild(topCheckbox);
    topLabel.appendChild(document.createTextNode(' ' + displayCatName));
    topDiv.appendChild(topLabel);

    // 3) Sub-level container
    const subContainer = document.createElement('div');
    subContainer.style.marginLeft = '1em';

    // Each sub-level
    if (subLevels && typeof subLevels === 'object') {
      for (const levelName in subLevels) {
        const tasks = subLevels[levelName];

        const levelDiv = document.createElement('div');
        levelDiv.className = 'sub-block';

        // sub-level checkbox
        const levelLabel = document.createElement('label');
        const levelCheckbox = document.createElement('input');
        levelCheckbox.type = 'checkbox';
        levelCheckbox.value = levelName;
        // default check
        levelCheckbox.checked = true;

        levelLabel.appendChild(levelCheckbox);
        levelLabel.appendChild(document.createTextNode(' ' + levelName));
        levelDiv.appendChild(levelLabel);

        // tasks container
        const tasksDiv = document.createElement('div');
        tasksDiv.style.marginLeft = '1em';

        // build each task checkbox
        if (Array.isArray(tasks)) {
          tasks.forEach(taskName => {
            const taskLabel = document.createElement('label');
            taskLabel.style.display = 'block';
            const tcb = document.createElement('input');
            tcb.type = 'checkbox';
            tcb.value = taskName;
            // default check
            tcb.checked = true;

            // display name can remain raw or you can do renameTask[taskName] ?? taskName
            const displayName = renameTask[taskName] || taskName;

            taskLabel.appendChild(tcb);
            taskLabel.appendChild(document.createTextNode(' ' + displayName));
            tasksDiv.appendChild(taskLabel);

            // If user toggles an individual task
            tcb.addEventListener('change', () => {
              syncCheckbox(levelCheckbox, tasksDiv);
              syncCheckbox(topCheckbox, subContainer);
              updateLeaderboard();
            });
          });
        }

        levelDiv.appendChild(tasksDiv);
        subContainer.appendChild(levelDiv);

        // If user toggles the sub-level
        levelCheckbox.addEventListener('change', e => {
          const isChecked = e.target.checked;
          tasksDiv.querySelectorAll('input[type=checkbox]').forEach(child => {
            child.checked = isChecked;
          });
          syncCheckbox(topCheckbox, subContainer);
          updateLeaderboard();
        });
      }
    }

    topDiv.appendChild(subContainer);
    container.appendChild(topDiv);

    // If user toggles the top-level category
    topCheckbox.addEventListener('change', e => {
      const isChecked = e.target.checked;
      subContainer.querySelectorAll('input[type=checkbox]').forEach(child => {
        child.checked = isChecked;
      });
      updateLeaderboard();
    });
  }
}

// HELPER: Mark parent as checked/unchecked/indeterminate
function syncCheckbox(parentCheckbox, container) {
  const boxes = container.querySelectorAll('input[type=checkbox]');
  const allChecked = Array.from(boxes).every(b => b.checked);
  const noneChecked = Array.from(boxes).every(b => !b.checked);
  if (allChecked) {
    parentCheckbox.checked = true;
    parentCheckbox.indeterminate = false;
  } else if (noneChecked) {
    parentCheckbox.checked = false;
    parentCheckbox.indeterminate = false;
  } else {
    parentCheckbox.checked = false;
    parentCheckbox.indeterminate = true;
  }
}

// Gather all tasks that are checked
function getSelectedTasks() {
  const container = document.getElementById('task-selector');
  // sub-level -> tasks
  const leafBoxes = container.querySelectorAll('.sub-block div label input[type=checkbox]');
  const tasks = [];
  leafBoxes.forEach(b => {
    if (b.checked) {
      tasks.push(b.value);
    }
  });
  return tasks;
}

//------------------------------------------------------------
// 4) LOAD CSV FILES + DATATABLE
//------------------------------------------------------------
function loadCSV(file, callback) {
  Papa.parse(file, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      // Insert 'Model' from filename, e.g. 'GPT', 'Llama'
      results.data.forEach(row => {
        row.Model = file.split('_')[0].replace('{{ site.baseurl }}/assets/data/', '');
      });
      callback(results.data);
    }
  });
}

function filterByTasks(data, selectedTasks) {
  if (!selectedTasks || selectedTasks.length === 0) {
    return [];
  }
  const allowed = new Set(selectedTasks);
  return data.filter(row => allowed.has(row.Task));
}

// rename method/model/task for display
function prettyMethod(method) {
  return renameMethod[method] || method;
}
function prettyModel(model) {
  return renameModel[model] || model;
}
function prettyTask(task) {
  return renameTask[task] || task;
}

function aggregateData(rows) {
  const map = new Map();
  rows.forEach(r => {
    const model = r.Model || 'Unknown';
    const method = r.Method || 'Unknown';
    const key = model + '||' + method;
    if (!map.has(key)) {
      map.set(key, {
        Model: model,
        Method: method,
        Accuracy: [],
        F1: [],
        Details: []
      });
    }
    const entry = map.get(key);
    entry.Accuracy.push(parseFloat(r.Accuracy));
    entry.F1.push(parseFloat(r.F1));
    entry.Details.push({ Task: r.Task, Accuracy: r.Accuracy, F1: r.F1 });
  });

  return Array.from(map.values()).map(e => {
    return {
      Model: e.Model,
      Method: e.Method,
      AvgAccuracy: (e.Accuracy.reduce((a, b) => a + b, 0) / e.Accuracy.length).toFixed(2),
      AvgF1: (e.F1.reduce((a, b) => a + b, 0) / e.F1.length).toFixed(2),
      Details: e.Details
    };
  });
}

function renderTable(data) {
  if (table) {
    table.destroy();
    $('#leaderboard').empty();
  }

  const tableData = data.map(row => {
    const displayModel = prettyModel(row.Model);
    const displayMethod = prettyMethod(row.Method);
    // data-expanded = "false" so we can track open/closed state.
    return [
      displayModel,
      displayMethod,
      row.AvgAccuracy,
      row.AvgF1,
      '<button class="details-btn" data-expanded="false">View</button>',
      JSON.stringify(row.Details)
    ];
  });

  table = $('#leaderboard').DataTable({
    data: tableData,
    columns: [
      { title: 'Model' },
      { title: 'Method' },
      { title: 'Avg Accuracy' },
      { title: 'Avg F1' },
      { title: 'Details' },
      { title: 'HiddenDetails', visible: false }
    ],
    order: [[3, 'desc']]
  });

  $('#leaderboard tbody').on('click', 'button.details-btn', function() {
    const row = table.row($(this).parents('tr'));
    const details = JSON.parse(row.data()[5]);
    // Check if expanded or not
    const isExpanded = $(this).attr('data-expanded') === 'true';

    if (!isExpanded) {
      // Expand details
      let html = '<div class="details"><strong>Per-Task Results:</strong><ul>';
      details.forEach(d => {
        const displayT = prettyTask(d.Task);
        html += `<li><strong>${displayT}</strong>: Accuracy=${d.Accuracy}, F1=${d.F1}</li>`;
      });
      html += '</ul></div>';
      // Insert the details div
      $(this).parent().append(html);
      // Mark expanded
      $(this).attr('data-expanded', 'true');
      $(this).text('Hide');
    } else {
      // Collapse details: remove .details
      $(this).parent().find('.details').remove();
      $(this).attr('data-expanded', 'false');
      $(this).text('View');
    }
  });
}

function updateLeaderboard() {
  const selectedTasks = getSelectedTasks();
  const filtered = filterByTasks(allData, selectedTasks);
  const aggregated = aggregateData(filtered);
  renderTable(aggregated);
}

// Toggles the entire #task-selector div
let tasksVisible = false;
const toggleBtn = document.getElementById('toggleTaskSelectorBtn');
// On page load, hide the task selector
document.getElementById('task-selector').style.display = 'none';
toggleBtn.textContent = 'Show Task Selection';

toggleBtn.addEventListener('click', () => {
  tasksVisible = !tasksVisible;
  document.getElementById('task-selector').style.display = tasksVisible ? 'block' : 'none';
  toggleBtn.textContent = tasksVisible ? 'Hide Task Selection' : 'Show Task Selection';
});

function initLeaderboard() {
  // 1) Build the nested checkbox UI (all checked by default)
  buildNestedUI();

  // 2) Load all CSVs
  let loadedCount = 0;
  csvFiles.forEach(file => {
    loadCSV(file, rows => {
      allData.push(...rows);
      loadedCount++;
      if (loadedCount === csvFiles.length) {
        // Everything loaded => show aggregated with all tasks selected
        updateLeaderboard();
      }
    });
  });
}

// Start
initLeaderboard();
</script>
